---
import StandingsTable from '../components/StandingsTable.astro';
import '../styles/standings.css';

const RAW_URL = 'https://raw.githubusercontent.com/durkinliam/nfl-sim-r/refs/heads/main/outright_output.json';
const COMMITS_API = 'https://api.github.com/repos/durkinliam/nfl-sim-r/commits?path=outright_output.json&per_page=1';

let data = null;
let lastCommitDateFormatted = null;
const buildTime = new Date();

const fmt = new Intl.DateTimeFormat('en-GB', {
  weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
  hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'UTC'
});

async function safeFetchJson(url, opts) {
  try {
    const res = await fetch(url, opts);
    if (!res.ok) return null;
    return await res.json();
  } catch (e) {
    return null;
  }
}

try {
  const raw = await safeFetchJson(RAW_URL, undefined);
  if (raw && Array.isArray(raw)) {
    data = raw.map((r) => ({ ...r }));

    data.sort((a, b) => {
      const aConf = (a.win_conf === undefined || a.win_conf === null || Number.isNaN(Number(a.win_conf))) ? Infinity : Number(a.win_conf);
      const bConf = (b.win_conf === undefined || b.win_conf === null || Number.isNaN(Number(b.win_conf))) ? Infinity : Number(b.win_conf);
      if (aConf !== bConf) return aConf - bConf;
      const aSb = (a.win_sb === undefined || a.win_sb === null || Number.isNaN(Number(a.win_sb))) ? Infinity : Number(a.win_sb);
      const bSb = (b.win_sb === undefined || b.win_sb === null || Number.isNaN(Number(b.win_sb))) ? Infinity : Number(b.win_sb);
      return aSb - bSb;
    });
  } else {
    data = null;
  }

  const headers = {};
  if (process.env.GITHUB_TOKEN) headers['Authorization'] = `token ${process.env.GITHUB_TOKEN}`;
  const commits = await safeFetchJson(COMMITS_API, { headers });
  if (commits && Array.isArray(commits) && commits.length > 0 && commits[0].commit && commits[0].commit.committer && commits[0].commit.committer.date) {
    const d = new Date(commits[0].commit.committer.date);
    lastCommitDateFormatted = `${fmt.format(d)} UTC`;
  } else {
    lastCommitDateFormatted = null;
  }
} catch (e) {
  data = null;
  lastCommitDateFormatted = null;
}

const buildTimeUTC = `${fmt.format(buildTime)} UTC`;
---

<html lang="en-GB">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NFL Season Simulations</title>
  </head>
  <body>
    <main>
      {lastCommitDateFormatted ? (
        <p class="timestamp">Data last updated: {lastCommitDateFormatted}</p>
      ) : (
        <p class="timestamp">Data last updated: unavailable â€” site built at {buildTimeUTC}</p>
      )}

      <StandingsTable data={data ?? []} lastUpdated={lastCommitDateFormatted} />

      <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;"></p>
    </main>
  </body>
</html>
