---
import StandingsTable from '../components/StandingsTable.astro';
import '../styles/standings.css';

const OWNER = 'durkinliam';
const REPO = 'nfl-sim-r';
const BRANCH = 'main';
const FILE_PATH = 'outright_output.json';

const RAW_URL = `https://raw.githubusercontent.com/${OWNER}/${REPO}/refs/heads/${BRANCH}/${FILE_PATH}`;
const CONTENTS_API = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}?ref=${BRANCH}`;
const COMMITS_API = `https://api.github.com/repos/${OWNER}/${REPO}/commits?path=${FILE_PATH}&per_page=1`;

let data = null;
let lastCommitDateFormatted = null;
const buildTime = new Date();

const fmt = new Intl.DateTimeFormat('en-GB', {
  weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
  hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'UTC'
});

async function safeFetchJson(url, opts) {
  try {
    const res = await fetch(url, opts);
    if (!res.ok) return null;
    return await res.json();
  } catch (e) {
    return null;
  }
}

async function fetchOutrightData() {
  const headers = {};
  if (process.env.GITHUB_TOKEN) headers['Authorization'] = `token ${process.env.GITHUB_TOKEN}`;
  const contents = await safeFetchJson(CONTENTS_API, { headers });
  if (contents && contents.content && contents.encoding === 'base64') {
    try {
      const decoded = Buffer.from(contents.content, 'base64').toString('utf-8');
      const parsed = JSON.parse(decoded);
      if (Array.isArray(parsed)) return parsed;
    } catch (_) {
      // ignore
    }
  }

  return null;
}

try {
  const raw = await fetchOutrightData();
  if (raw && Array.isArray(raw)) {
    data = raw.map((r) => ({ ...r }));

    data.sort((a, b) => {
      const aConf = (a.win_conf === undefined || a.win_conf === null || Number.isNaN(Number(a.win_conf))) ? Infinity : Number(a.win_conf);
      const bConf = (b.win_conf === undefined || b.win_conf === null || Number.isNaN(Number(b.win_conf))) ? Infinity : Number(b.win_conf);
      if (aConf !== bConf) return aConf - bConf;
      const aSb = (a.win_sb === undefined || a.win_sb === null || Number.isNaN(Number(a.win_sb))) ? Infinity : Number(a.win_sb);
      const bSb = (b.win_sb === undefined || b.win_sb === null || Number.isNaN(Number(b.win_sb))) ? Infinity : Number(b.win_sb);
      return aSb - bSb;
    });
  } else {
    data = null;
  }

  const headers = {};
  if (process.env.GITHUB_TOKEN) headers['Authorization'] = `token ${process.env.GITHUB_TOKEN}`;
  const commits = await safeFetchJson(COMMITS_API, { headers });
  if (commits && Array.isArray(commits) && commits.length > 0 && commits[0].commit && commits[0].commit.committer && commits[0].commit.committer.date) {
    const d = new Date(commits[0].commit.committer.date);
    lastCommitDateFormatted = `${fmt.format(d)} UTC`;
  } else {
    lastCommitDateFormatted = null;
  }
} catch (e) {
  data = null;
  lastCommitDateFormatted = null;
}

const buildTimeUTC = `${fmt.format(buildTime)} UTC`;
---

<html lang="en-GB">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NFL Season Simulations</title>
  </head>
  <body>
    <main>
      {lastCommitDateFormatted ? (
        <p class="timestamp">Data last updated: {lastCommitDateFormatted}</p>
      ) : (
        <p class="timestamp">Data last updated: unavailable â€” site built at {buildTimeUTC}</p>
      )}

      <StandingsTable data={data ?? []} lastUpdated={lastCommitDateFormatted} />

      <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;"></p>
    </main>
  </body>
</html>
