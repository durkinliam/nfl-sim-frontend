---
// Props: data: Array<Record<string, any>>
const { data } = Astro.props;

function fmt(v: unknown): string {
  const n = Number(v);
  if (v === undefined || v === null || !Number.isFinite(n)) return 'Inf';
  return n.toFixed(2);
}

function teamSlug(team: unknown): string {
  if (!team) return '';
  return String(team)
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}
---

<div class="standings">
  <div class="actions">
    <button id="defaultSortBtn" type="button" class="sort-btn">Win Division</button>
    <button id="winConfBtn" type="button" class="sort-btn">Win Conference</button>
    <button id="winSbBtn" type="button" class="sort-btn">Win Super Bowl</button>
  </div>

  <div class="table-wrap">
    {Array.isArray(data) && data.length > 0 ? (
      <table class="standings">
        <thead>
          <tr>
            <th data-key="conf" class="sortable" scope="col" aria-sort="none">Conf</th>
            <th data-key="division" class="sortable" scope="col" aria-sort="none">Division</th>
            <th data-key="team" class="sortable" scope="col" aria-sort="none">Team</th>
            <th data-key="wins" class="sortable" scope="col" aria-sort="none">Regular Season Wins</th>
            <th data-key="make_playoffs" class="sortable" scope="col" aria-sort="none">Make Playoffs</th>
            <th data-key="win_div" class="sortable" scope="col" aria-sort="none">Win Division</th>
            <th data-key="win_conf" class="sortable" scope="col" aria-sort="none">Win Conference</th>
            <th data-key="win_sb" class="sortable" scope="col" aria-sort="none">Win Super Bowl</th>
          </tr>
        </thead>
        <tbody>
          {data.map((row) => {
            const name = row.team ?? '';
            const slug = teamSlug(name);
            const base = import.meta.env.BASE_URL || '/';
            const defaultLogo = slug ? `${base}logos/${slug}.png` : '';
            const url = row.logo_url ?? defaultLogo;
            return (
              <tr
                data-conf={row.conf ?? ''}
                data-division={row.division ?? ''}
                data-team={row.team ?? ''}
                data-wins={row.wins ?? ''}
                data-make-playoffs={row.make_playoffs ?? ''}
                data-win-div={row.win_div ?? ''}
                data-win-conf={row.win_conf ?? ''}
                data-win-sb={row.win_sb ?? ''}
              >
                <td>{row.conf ?? 'Inf'}</td>
                <td>{row.division ?? 'Inf'}</td>
                <td class="team-cell">
                  {url ? (
                    <img src={url} alt={`${name || 'Team'} logo`} class="team-logo" onerror="this.style.display='none'" />
                  ) : null}
                  <span>{name || 'Inf'}</span>
                </td>
                <td>{fmt(row.wins)}</td>
                <td>{fmt(row.make_playoffs)}</td>
                <td>{fmt(row.win_div)}</td>
                <td>{fmt(row.win_conf)}</td>
                <td>{fmt(row.win_sb)}</td>
              </tr>
            );
          })}
        </tbody>
      </table>
    ) : (
      <div class="empty-msg">Data currently unavailable â€” please try again later.</div>
    )}
  </div>
</div>

<style>
.team-cell { display: flex; align-items: center; gap: 0.5rem; }
.team-logo { width: 24px; height: 24px; object-fit: contain; }
</style>

<script>
(() => {
  const table = document.querySelector('.standings');
  if (!table) return;
  const tbody = table.querySelector('tbody');
  const headerCells = Array.from(table.querySelectorAll('thead th')) as HTMLElement[];

  // build row model
  const rows = Array.from(tbody.querySelectorAll('tr')).map((tr) => {
    const td = (i) => tr.children[i]?.textContent?.trim() || '';
    const values = {
      conf: tr.getAttribute('data-conf') || td(0),
      division: tr.getAttribute('data-division') || td(1),
      team: tr.getAttribute('data-team') || td(2),
      wins: tr.getAttribute('data-wins') || td(3),
      make_playoffs: tr.getAttribute('data-make-playoffs') || td(4),
      win_div: tr.getAttribute('data-win-div') || td(5),
      win_conf: tr.getAttribute('data-win-conf') || td(6),
      win_sb: tr.getAttribute('data-win-sb') || td(7)
    };
    return { tr, values };
  });

  function parseNumeric(v) {
    if (v === undefined || v === null || v === '') return Infinity;
    const n = Number(v);
    return Number.isFinite(n) ? n : Infinity;
  }

  function compareByKey(a, b, key, dir = 1) {
    const av = a.values[key];
    const bv = b.values[key];
    if (['wins','make_playoffs','win_div','win_conf','win_sb'].includes(key)) {
      const an = parseNumeric(av);
      const bn = parseNumeric(bv);
      if (an !== bn) return dir * (an - bn);
      return 0;
    }
    const cmp = String(av).localeCompare(String(bv), undefined, { numeric: true, sensitivity: 'base' });
    return dir * cmp;
  }

  let sortKeys = ['division', 'win_div'];
  let sortDirs = [1, 1];

  function applySort() {
    const copy = rows.slice();
    copy.sort((a, b) => {
      for (let i = 0; i < sortKeys.length; i++) {
        const k = sortKeys[i];
        const d = sortDirs[i] ?? 1;
        const cmp = compareByKey(a, b, k, d);
        if (cmp !== 0) return cmp;
      }
      return 0;
    });

    headerCells.forEach((th) => {
      th.classList.remove('sorted-asc', 'sorted-desc');
      th.setAttribute('aria-sort', 'none');
    });
    const primaryKey = sortKeys[0];
    const primaryDir = sortDirs[0];
    const primaryTh = headerCells.find(h => (h as HTMLElement).dataset.key === primaryKey);
    if (primaryTh) {
      primaryTh.classList.add(primaryDir === 1 ? 'sorted-asc' : 'sorted-desc');
      primaryTh.setAttribute('aria-sort', primaryDir === 1 ? 'ascending' : 'descending');
    }

    const frag = document.createDocumentFragment();
    copy.forEach((r) => frag.appendChild(r.tr));
    tbody.innerHTML = '';
    tbody.appendChild(frag);
  }

  applySort();

  headerCells.forEach((th) => {
    const key = (th as HTMLElement).dataset.key as string;
    th.addEventListener('click', () => {
      if (key === sortKeys[0]) {
        sortDirs[0] = -sortDirs[0];
      } else {
        if (key === 'division') {
          sortKeys = ['division', 'win_div'];
          sortDirs = [1, 1];
        } else if (key === 'win_conf') {
          sortKeys = ['conf', 'win_conf'];
          sortDirs = [1, 1];
        } else if (key === 'win_sb') {
          sortKeys = ['win_sb'];
          sortDirs = [1];
        } else {
          sortKeys = [key];
          sortDirs = [1];
        }
      }
      applySort();
    });
  });

  const defaultBtn = document.getElementById('defaultSortBtn');
  const winConfBtn = document.getElementById('winConfBtn');
  const winSbBtn = document.getElementById('winSbBtn');

  defaultBtn?.addEventListener('click', () => {
    sortKeys = ['division', 'win_div'];
    sortDirs = [1, 1];
    applySort();
  });
  winConfBtn?.addEventListener('click', () => {
    sortKeys = ['conf', 'win_conf'];
    sortDirs = [1, 1];
    applySort();
  });
  winSbBtn?.addEventListener('click', () => {
    sortKeys = ['win_sb'];
    sortDirs = [1];
    applySort();
  });
})();
</script>
